<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>生年月日逆算ツール</title>
  <style>
    :root {
      --bg: #f4f7f9;
      --card: #ffffff;
      --line: #d7e0e7;
      --text: #1d2a33;
      --sub: #586b78;
      --accent: #005bbb;
      --accent-strong: #00428a;
      --danger: #b00020;
      --shadow: 0 8px 24px rgba(14, 32, 58, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top left, #e8f2ff, var(--bg) 42%);
    }

    main {
      max-width: 980px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 1.8rem;
    }

    .subtitle {
      margin: 0 0 20px;
      color: var(--sub);
      line-height: 1.5;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 16px;
      margin-bottom: 16px;
    }

    .people-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .person-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px;
      background: #fbfdff;
    }

    .person-card h2 {
      margin: 0 0 10px;
      font-size: 1.05rem;
    }

    label {
      display: block;
      font-size: 0.9rem;
      color: var(--sub);
      margin-bottom: 4px;
    }

    input {
      width: 100%;
      border: 1px solid #c5d2dd;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .birthday-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .result {
      min-height: 2.2rem;
      margin-top: 2px;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #eef5ff;
    }

    .result.error {
      background: #ffecef;
      color: var(--danger);
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    button {
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.95rem;
      cursor: pointer;
    }

    #calcBtn {
      background: var(--accent);
      color: #fff;
    }

    #calcBtn:hover {
      background: var(--accent-strong);
    }

    #clearHistoryBtn {
      background: #f0f2f5;
      color: var(--text);
      border: 1px solid var(--line);
    }

    .history-empty {
      color: var(--sub);
      margin: 0;
    }

    .history-list {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .history-item {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fafcfe;
    }

    .history-time {
      font-size: 0.85rem;
      color: var(--sub);
      margin-bottom: 8px;
    }

    .history-item ul {
      margin: 0;
      padding-left: 18px;
    }

    .hint {
      font-size: 0.85rem;
      color: var(--sub);
      margin: 6px 0 0;
      line-height: 1.45;
    }
  </style>
</head>
<body>
  <main>
    <h1>生年月日 逆算ツール</h1>
    <p class="subtitle" id="todayText"></p>

    <section class="panel">
      <div class="people-grid" id="peopleGrid"></div>
      <div class="actions">
        <button id="calcBtn" type="button">生年月日を逆算する</button>
      </div>
      <p class="hint">
        年齢と誕生日（月日）が分かる人の生年月日を推定します。最大3人まで入力できます。
      </p>
      <p class="hint">
        ブラウザのお気に入り登録: Windowsは <strong>Ctrl + D</strong> / Macは <strong>Command + D</strong>
      </p>
    </section>

    <section class="panel">
      <h2>履歴</h2>
      <div class="actions">
        <button id="clearHistoryBtn" type="button">履歴をクリア</button>
      </div>
      <div id="historyContainer"></div>
    </section>
  </main>

  <script>
    const MAX_PEOPLE = 3;
    const HISTORY_KEY = "seinengappi_history_v1";

    const today = new Date();
    const todayYear = today.getFullYear();
    const todayMonth = today.getMonth() + 1;
    const todayDay = today.getDate();

    const peopleGrid = document.getElementById("peopleGrid");
    const historyContainer = document.getElementById("historyContainer");
    const todayText = document.getElementById("todayText");
    todayText.textContent = "今日の基準日: " + formatDate(todayYear, todayMonth, todayDay);

    for (let i = 1; i <= MAX_PEOPLE; i += 1) {
      const card = document.createElement("article");
      card.className = "person-card";
      card.innerHTML = `
        <h2>${i}人目</h2>
        <label for="name${i}">名前（任意）</label>
        <input id="name${i}" type="text" placeholder="例: 山田 太郎">
        <label for="age${i}">今の年齢</label>
        <input id="age${i}" type="number" min="0" max="130" placeholder="例: 28">
        <label>誕生日（月 / 日）</label>
        <div class="birthday-row">
          <input id="month${i}" type="number" min="1" max="12" placeholder="月">
          <input id="day${i}" type="number" min="1" max="31" placeholder="日">
        </div>
        <div id="result${i}" class="result">未計算</div>
      `;
      peopleGrid.appendChild(card);
    }

    document.getElementById("calcBtn").addEventListener("click", calculateAll);
    document.getElementById("clearHistoryBtn").addEventListener("click", clearHistory);

    renderHistory();

    function calculateAll() {
      const computed = [];

      for (let i = 1; i <= MAX_PEOPLE; i += 1) {
        const name = getValue("name" + i);
        const ageRaw = getValue("age" + i);
        const monthRaw = getValue("month" + i);
        const dayRaw = getValue("day" + i);
        const resultEl = document.getElementById("result" + i);

        if (!ageRaw && !monthRaw && !dayRaw && !name) {
          resultEl.textContent = "未入力";
          resultEl.classList.remove("error");
          continue;
        }

        const age = Number(ageRaw);
        const month = Number(monthRaw);
        const day = Number(dayRaw);

        if (!Number.isInteger(age) || age < 0 || age > 130) {
          setError(resultEl, "年齢を0〜130で入力してください。");
          continue;
        }

        if (!isValidMonthDay(month, day)) {
          setError(resultEl, "誕生日（月/日）が正しくありません。");
          continue;
        }

        const hasPassedThisYear =
          todayMonth > month || (todayMonth === month && todayDay >= day);
        const birthYear = hasPassedThisYear ? todayYear - age : todayYear - age - 1;

        if (!isValidDate(birthYear, month, day)) {
          setError(resultEl, "入力情報の整合性が取れません。年齢を確認してください。");
          continue;
        }

        const birthDate = formatDate(birthYear, month, day);
        const displayName = name || i + "人目";
        resultEl.textContent = displayName + ": " + birthDate;
        resultEl.classList.remove("error");
        computed.push({ name: displayName, age: age, birthday: month + "/" + day, birthDate: birthDate });
      }

      if (computed.length > 0) {
        saveHistory(computed);
        renderHistory();
      }
    }

    function getValue(id) {
      return document.getElementById(id).value.trim();
    }

    function isValidMonthDay(month, day) {
      if (!Number.isInteger(month) || !Number.isInteger(day)) {
        return false;
      }
      if (month < 1 || month > 12 || day < 1) {
        return false;
      }
      const tempYear = 2000;
      return isValidDate(tempYear, month, day);
    }

    function isValidDate(year, month, day) {
      const date = new Date(year, month - 1, day);
      return (
        date.getFullYear() === year &&
        date.getMonth() === month - 1 &&
        date.getDate() === day
      );
    }

    function formatDate(year, month, day) {
      return (
        String(year).padStart(4, "0") +
        "-" +
        String(month).padStart(2, "0") +
        "-" +
        String(day).padStart(2, "0")
      );
    }

    function setError(element, message) {
      element.textContent = message;
      element.classList.add("error");
    }

    function getHistory() {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) {
        return [];
      }
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        return [];
      }
    }

    function saveHistory(items) {
      const history = getHistory();
      history.unshift({
        createdAt: new Date().toISOString(),
        items: items
      });
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 100)));
    }

    function clearHistory() {
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
    }

    function renderHistory() {
      const history = getHistory();
      if (history.length === 0) {
        historyContainer.innerHTML = '<p class="history-empty">履歴はまだありません。</p>';
        return;
      }

      const list = document.createElement("div");
      list.className = "history-list";

      history.forEach((entry) => {
        const item = document.createElement("article");
        item.className = "history-item";

        const date = new Date(entry.createdAt);
        const timeText = date.toLocaleString("ja-JP");
        const lines = entry.items
          .map((person) =>
            "<li>" +
              escapeHtml(person.name) +
              " (年齢 " +
              person.age +
              " / 誕生日 " +
              person.birthday +
              ") → " +
              escapeHtml(person.birthDate) +
            "</li>"
          )
          .join("");

        item.innerHTML =
          '<div class="history-time">' + escapeHtml(timeText) + "</div>" +
          "<ul>" + lines + "</ul>";
        list.appendChild(item);
      });

      historyContainer.innerHTML = "";
      historyContainer.appendChild(list);
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }
  </script>
</body>
</html>
